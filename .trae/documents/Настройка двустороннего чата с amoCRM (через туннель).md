# План настройки двустороннего чата (Telegram ↔ amoCRM)

## 1. Установка зависимостей
Установим библиотеки для веб-сервера и туннелирования, необходимые для приема сообщений от менеджеров.
*   `pyngrok` — для доступа к вашему компьютеру из интернета.
*   `aiohttp` — легкий веб-сервер для приема вебхуков.
*   `python-dotenv` — уже стоит, но проверим.

## 2. Регистрация канала в amoCRM
Нам нужно зарегистрировать бота как официальный канал чата в вашем аккаунте.
*   Создадим скрипт `register_chat_channel.py`.
*   Скрипт свяжется с API amoCRM и получит `AMOCRM_CHAT_CHANNEL_ID` и `AMOCRM_CHAT_SECRET`.
*   Сохраним эти данные в `.env`.

## 3. Обновление модуля интеграции (`kommo.py`)
Добавим функционал для работы с Chat API.
*   Метод `connect_chat_channel` — для первоначальной связи.
*   Метод `send_message_to_chat` — для отправки сообщений от пользователя в CRM.
*   Метод `verify_webhook_signature` — для проверки, что сообщение действительно от amoCRM.

## 4. Обновление логики бота (`bot.py`)
Превратим бота в гибрид (Polling + Webhook).
*   **Входящие (User -> CRM):** Добавим `MessageHandler(filters.TEXT)`, который пересылает текст в CRM.
*   **Исходящие (CRM -> User):**
    *   При старте бота запускаем `ngrok` (получаем публичную ссылку `https://...ngrok-free.app`).
    *   Поднимаем веб-сервер на порту 8000.
    *   Регистрируем этот вебхук в amoCRM.
    *   При получении сообщения от менеджера -> `bot.send_message` пользователю.

## 5. Тестирование
*   Запустим бота.
*   Напишем "Привет" боту в Telegram -> проверим, появилось ли сообщение в "Неразобранном" или в чате карточки.
*   Напишем ответ из CRM -> проверим, пришел ли он в Telegram.
